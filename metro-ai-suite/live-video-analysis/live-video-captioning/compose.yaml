# Copyright (C) 2025 Intel Corporation
# SPDX-License-Identifier: Apache-2.0

name: ${PROJECT_NAME:-live-video-caption}
services:
  mqtt-broker:
    image: eclipse-mosquitto:2.0
    hostname: mqtt-broker
    container_name: mqtt-broker
    environment:
      - no_proxy=localhost,127.0.0.1,mediamtx,coturn,dlstreamer-pipeline-server,video-caption-service,collector,mqtt-broker,${no_proxy}
      - NO_PROXY=localhost,127.0.0.1,mediamtx,coturn,dlstreamer-pipeline-server,video-caption-service,collector,mqtt-broker,${NO_PROXY}
      - http_proxy=$http_proxy
      - HTTP_PROXY=$http_proxy
      - https_proxy=$https_proxy
      - HTTPS_PROXY=$https_proxy
    ports:
      - "${MQTT_PORT:-1883}:1883"
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    restart: unless-stopped
    networks:
      - app_network

  dlstreamer-pipeline-server:
    image: intel/dlstreamer-pipeline-server:2025.2.0-ubuntu24
    hostname: dlstreamer-pipeline-server
    container_name: dlstreamer-pipeline-server
    read_only: false
    security_opt:
      - no-new-privileges
    privileged: true
    tty: true
    entrypoint: [ "./run.sh" ]
    depends_on:
      - mediamtx
      - mqtt-broker
    ports:
      - "${EVAM_HOST_PORT:-8040}:${EVAM_PORT:-8080}"
      - "8556:8554"
    environment:
      - no_proxy=localhost,127.0.0.1,mediamtx,coturn,dlstreamer-pipeline-server,video-caption-service,collector,mqtt-broker,${no_proxy}
      - NO_PROXY=localhost,127.0.0.1,mediamtx,coturn,dlstreamer-pipeline-server,video-caption-service,collector,mqtt-broker,${NO_PROXY}
      - http_proxy=$http_proxy
      - HTTP_PROXY=$http_proxy
      - https_proxy=$https_proxy
      - HTTPS_PROXY=$https_proxy
      - RUN_MODE=EVA
      - ENABLE_RTSP=false
      - ENABLE_WEBRTC=true
      - REST_SERVER_PORT=8554
      # Default Detection and Classification Device
      - DETECTION_DEVICE=CPU
      - ADD_UTCTIME_TO_METADATA=true
      - LSFEATURE_NAME="EVAM"
      - HTTPS=false # Make it "true" to enable SSL/TLS secure mode, mount the generated certificates
      - MTLS_VERIFICATION=false # if HTTPS=true, enable/disable client certificate verification for mTLS
      # Append pipeline name to a publisher topic
      - APPEND_PIPELINE_NAME_TO_PUBLISHER_TOPIC=false
      - REST_SERVER_PORT=${EVAM_PORT:-8080}
      - WEBRTC_SIGNALING_SERVER=http://mediamtx:${WHIP_SERVER_PORT:-8889}
      - MQTT_HOST=mqtt-broker
      - MQTT_PORT=1883
      # Debug logging for MQTT publishing
      - GST_DEBUG=1
    volumes:
      - vol_evam_pipeline_root:/var/cache/pipeline_root:uid=1999,gid=1999
      - "/run/udev:/run/udev:ro"
      - "/dev:/dev"
      - "/tmp:/tmp"
      - ./ov_models:/home/pipeline-server/models
      - ./ov_detection_models:/home/pipeline-server/detection_models
      - ./user_scripts/:/home/pipeline-server/gvapython/publisher/
      - ./config.json:/home/pipeline-server/config.json:ro
    group_add:
      # render group ID for ubuntu 20.04 host OS
      - "109"
      # render group ID for ubuntu 22.04 host OS
      - "110"
      # render group ID for ubuntu 24.04 host OS
      - "992"
    device_cgroup_rules:
      # Default run - device-cgroup-rule='c 189:* rmw'
      # Selective rules can be applied for deployment
      - 'c 189:* rmw'
      - 'c 209:* rmw'
      - 'a 189:* rwm'
    devices:
      # Following devices under /dev filesystem will be needed based on usecase
      # dri - GPU
      # USB camera devices
      # Selective mount can be done for deployment as mounting whole /dev is not recommended
      - "/dev/dri:/dev/dri"
    networks:
      - app_network

  mediamtx:
    image: bluenviron/mediamtx:1.11.3
    container_name: mediamtx
    environment:
      - no_proxy=localhost,127.0.0.1,mediamtx,coturn,dlstreamer-pipeline-server,video-caption-service,collector,${no_proxy}
      - NO_PROXY=localhost,127.0.0.1,mediamtx,coturn,dlstreamer-pipeline-server,video-caption-service,collector,${NO_PROXY}
      - http_proxy=$http_proxy
      - HTTP_PROXY=$http_proxy
      - https_proxy=$https_proxy
      - HTTPS_PROXY=$https_proxy
      - MTX_LOGLEVEL=info
      - MTX_RTSP=no
      - MTX_RTMP=no
      - MTX_SRT=no
      - MTX_HLS=no
      - MTX_WEBRTCTRACKGATHERTIMEOUT=30s
      - MTX_WEBRTCADDRESS=:8889
      - MTX_WEBRTCICESERVERS2_0_URL=turn:${HOST_IP:-localhost}:3478
      - MTX_WEBRTCICESERVERS2_0_USERNAME=${MTX_WEBRTCICESERVERS2_0_USERNAME:-localhost}
      - MTX_WEBRTCICESERVERS2_0_PASSWORD=${MTX_WEBRTCICESERVERS2_0_PASSWORD:-localpass}
    ports:
      - "${WHIP_SERVER_PORT}:8889"
      - "8189:8189"
      - "9997:9997"
    restart: unless-stopped
    networks:
      - app_network

  coturn:
    image: coturn/coturn:latest
    container_name: coturn
    environment:
      - no_proxy=localhost,127.0.0.1,mediamtx,coturn,dlstreamer-pipeline-server,video-caption-service,collector,${no_proxy}
      - NO_PROXY=localhost,127.0.0.1,mediamtx,coturn,dlstreamer-pipeline-server,video-caption-service,collector,${NO_PROXY}
      - http_proxy=$http_proxy
      - HTTP_PROXY=$http_proxy
      - https_proxy=$https_proxy
      - HTTPS_PROXY=$https_proxy
    ports:
      - "3478:3478/udp"
    command: [ "-v" ] # Verbose mode for logging
    networks:
      - app_network

  video-caption-service:
    image: ${REGISTRY:-}video-caption-service:${TAG:-latest}
    build: ./app
    container_name: video-caption-service
    environment:
      - no_proxy=localhost,127.0.0.1,mediamtx,coturn,dlstreamer-pipeline-server,video-caption-service,collector,mqtt-broker,${no_proxy}
      - NO_PROXY=localhost,127.0.0.1,mediamtx,coturn,dlstreamer-pipeline-server,video-caption-service,collector,mqtt-broker,${NO_PROXY}
      - http_proxy=$http_proxy
      - HTTP_PROXY=$http_proxy
      - https_proxy=$https_proxy
      - HTTPS_PROXY=$https_proxy
      - DASHBOARD_PORT=4173
      - MQTT_BROKER_HOST=mqtt-broker
      - MQTT_BROKER_PORT=1883
      - MQTT_TOPIC_PREFIX=live-video-captioning
      - WEBRTC_PEER_ID=${WEBRTC_PEER_ID:-stream}
      - SIGNALING_URL=http://${HOST_IP:-localhost}:${WHIP_SERVER_PORT:-8889}
      - AGENT_MODE=${AGENT_MODE:-false}
      - DEFAULT_RTSP_URL=${DEFAULT_RTSP_URL:-}
      - ENABLE_DETECTION_PIPELINE=${ENABLE_DETECTION_PIPELINE:-false}
    volumes:
      - "./ov_models:/app/ov_models:ro"
      - "./ov_detection_models:/app/ov_detection_models:ro"
    ports:
      - "${DASHBOARD_PORT:-4173}:4173"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4173/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    depends_on:
      - dlstreamer-pipeline-server
      - mediamtx
      - mqtt-broker
    networks:
      - app_network

  collector:
    image: docker.io/intel/vippet-collector:2025.2.0
    container_name: collector
    ports:
      - "9273:9273"
    privileged: true
    devices:
      - "/sys:/sys"
      - "/dev:/dev"
      - "/run:/run"
      - "/proc:/proc"
    pid: host # qmassa needs it
    volumes:
      - "./shared/collector-signals:/app/.collector-signals"
      - "./collector/telegraf.conf:/etc/telegraf/telegraf.conf:ro"
    restart: on-failure:5
    environment:
      - http_proxy=${http_proxy}
      - https_proxy=${https_proxy}
      - no_proxy=localhost,127.0.0.1,video-caption-service,collector,${no_proxy}
      - WEBSOCKET_URL=ws://video-caption-service:4173/ws/collector
    depends_on:
      - video-caption-service
    networks:
      - app_network

volumes:
  vol_evam_pipeline_root:
    driver: local
    driver_opts:
      type: tmpfs
      device: tmpfs

networks:
  app_network:
    driver: bridge
